[1mdiff --git a/Command.cs b/Command.cs[m
[1mindex 80e0139..f4f814f 100644[m
[1m--- a/Command.cs[m
[1m+++ b/Command.cs[m
[36m@@ -6,6 +6,7 @@[m [musing Autodesk.AutoCAD.Runtime;[m
 using Autodesk.AutoCAD.Windows;[m
 using Autodesk.Windows;[m
 using BoundingRectangle;[m
[32m+[m[32musing Markdig;[m
 using Newtonsoft.Json;[m
 using System;[m
 using System.Collections.Generic;[m
[36m@@ -595,7 +596,18 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                     double y = point[1];[m
                     double z = 0;[m
                     insertPoints.Add(new Point3d(x, y, z));[m
[31m-                    InsertBlockFromDwg(new Point3d(x, y, z), LightLayer, "gen_light");[m
[32m+[m
[32m+[m[32m                    string lightName;[m
[32m+[m[32m                    if (lightType.Contains("å¸é¡¶"))[m
[32m+[m[32m                        lightName = "æ„Ÿåº”å¼å¸é¡¶ç¯";[m
[32m+[m[32m                    else if (lightType.Contains("é˜²çˆ†"))[m
[32m+[m[32m                        lightName = "é˜²çˆ†ç¯";[m
[32m+[m[32m                    else if (lightType.Contains("é¢æ¿"))[m
[32m+[m[32m                        lightName = "åŒç®¡è§å…‰ç¯";[m
[32m+[m[32m                    else[m
[32m+[m[32m                        lightName = "gen_light";[m
[32m+[m
[32m+[m[32m                    InsertBlockFromDwg(new Point3d(x, y, z), LightLayer, lightName);[m
                 }[m
             }[m
             // æ’å…¥æ’åº§[m
[36m@@ -985,6 +997,16 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
             var aiContentControl = await dlg.AppendMessageAsync("AI", "", true, setter => updateFunc = setter);[m
             await dlg.GetAIResponse(prompt, updateFunc);[m
         }[m
[32m+[m[32m        [CommandMethod("MM", CommandFlags.Session)][m
[32m+[m[32m        public void TestMarkdig()[m
[32m+[m[32m        {[m
[32m+[m[32m            Document doc = CADApplication.DocumentManager.MdiActiveDocument;[m
[32m+[m[32m            Editor ed = doc.Editor;[m
[32m+[m[32m            Database db = doc.Database;[m
[32m+[m[32m            var pipeline = new MarkdownPipelineBuilder().UseAdvancedExtensions().Build();[m
[32m+[m[32m            var result = Markdown.ToHtml("| ç¯å…·ç±»å‹ | ä¸ªæ•° | ç“¦æ•° | \r\n|---------|-----|-----|\r\n | å¸é¡¶ç¯ | 2 | 20W | | é˜²çˆ†ç¯ | 3 | 50W | | è§å…‰ç¯ | 5 | 60W |", pipeline);[m
[32m+[m[32m            ed.WriteMessage($"{result}");   // prints: <p>This is a text with some <em>emphasis</em></p>[m
[32m+[m[32m        }[m
         #endregion[m
     }[m
     }[m
[1mdiff --git a/PaletteSetDlg.cs b/PaletteSetDlg.cs[m
[1mindex 4cedf7a..1369bf1 100644[m
[1m--- a/PaletteSetDlg.cs[m
[1m+++ b/PaletteSetDlg.cs[m
[36m@@ -25,6 +25,14 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
         private Panel conversationPanel;[m
         private TextBox inputTextBox;[m
         private Button sendButton;[m
[32m+[m[32m        private static readonly int fontsize = 14;[m
[32m+[m[32m        private static readonly string htmlsize = $"{fontsize}pt";[m
[32m+[m
[32m+[m[32m        // è‡ªåŠ¨æ»šåŠ¨ç›¸å…³å˜é‡[m
[32m+[m[32m        private bool isAutoScrollEnabled = true;[m
[32m+[m[32m        private int scrollThreshold = 50; // è·ç¦»åº•éƒ¨50pxå†…è®¤ä¸ºåœ¨åº•éƒ¨[m
[32m+[m[32m        private DateTime lastUserScrollTime = DateTime.MinValue;[m
[32m+[m[32m        private Control currentAIControl = null; // å½“å‰æ­£åœ¨æ›´æ–°çš„AIæ§ä»¶[m
 [m
         public PaletteSetDlg()[m
         {[m
[36m@@ -45,6 +53,8 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                 FlowDirection = System.Windows.Forms.FlowDirection.TopDown,[m
                 WrapContents = false[m
             };[m
[32m+[m[32m            conversationPanel.Scroll += ConversationPanel_Scroll;[m
[32m+[m[32m            conversationPanel.MouseWheel += ConversationPanel_MouseWheel;[m
             conversationPanel.Resize += ConversationPanel_Resize;[m
 [m
             // è¾“å…¥åŒºåŸŸ[m
[36m@@ -76,6 +86,111 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
             this.Controls.Add(conversationPanel);[m
             this.Controls.Add(inputPanel);[m
         }[m
[32m+[m[32m        #region æ»šåŠ¨æ£€æµ‹å’Œæ§åˆ¶[m
[32m+[m
[32m+[m[32m        /// <summary>[m
[32m+[m[32m        /// æ£€æµ‹æ˜¯å¦æ¥è¿‘åº•éƒ¨[m
[32m+[m[32m        /// </summary>[m
[32m+[m[32m        private bool IsNearBottom()[m
[32m+[m[32m        {[m
[32m+[m[32m            if (conversationPanel.Controls.Count == 0) return true;[m
[32m+[m
[32m+[m[32m            var verticalScroll = conversationPanel.VerticalScroll;[m
[32m+[m[32m            int currentScrollPosition = verticalScroll.Value;[m
[32m+[m[32m            int maxScrollPosition = verticalScroll.Maximum - conversationPanel.Height;[m
[32m+[m
[32m+[m[32m            return (maxScrollPosition - currentScrollPosition) <= scrollThreshold;[m
[32m+[m[32m        }[m
[32m+[m[32m        /// <summary>[m
[32m+[m[32m        /// æ»šåŠ¨äº‹ä»¶å¤„ç†[m
[32m+[m[32m        /// </summary>[m
[32m+[m[32m        private void ConversationPanel_Scroll(object sender, ScrollEventArgs e)[m
[32m+[m[32m        {[m
[32m+[m[32m            // è®°å½•ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨çš„æ—¶é—´[m
[32m+[m[32m            if (e.Type == ScrollEventType.ThumbTrack || e.Type == ScrollEventType.ThumbPosition)[m
[32m+[m[32m            {[m
[32m+[m[32m                lastUserScrollTime = DateTime.Now;[m
[32m+[m
[32m+[m[32m                // å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œé‡æ–°å¯ç”¨è‡ªåŠ¨æ»šåŠ¨[m
[32m+[m[32m                if (IsNearBottom())[m
[32m+[m[32m                {[m
[32m+[m[32m                    isAutoScrollEnabled = true;[m
[32m+[m[32m                }[m
[32m+[m[32m                else[m
[32m+[m[32m                {[m
[32m+[m[32m                    // å¦‚æœç”¨æˆ·å‘ä¸Šæ»šåŠ¨ï¼Œæš‚æ—¶ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨[m
[32m+[m[32m                    isAutoScrollEnabled = false;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        /// <summary>[m
[32m+[m[32m        /// é¼ æ ‡æ»šè½®äº‹ä»¶å¤„ç†[m
[32m+[m[32m        /// </summary>[m
[32m+[m[32m        private void ConversationPanel_MouseWheel(object sender, MouseEventArgs e)[m
[32m+[m[32m        {[m
[32m+[m[32m            lastUserScrollTime = DateTime.Now;[m
[32m+[m
[32m+[m[32m            // æ£€æŸ¥æ»šåŠ¨æ–¹å‘å’Œä½ç½®[m
[32m+[m[32m            if (e.Delta < 0) // å‘ä¸‹æ»šåŠ¨[m
[32m+[m[32m            {[m
[32m+[m[32m                if (IsNearBottom())[m
[32m+[m[32m                {[m
[32m+[m[32m                    isAutoScrollEnabled = true;[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m            else // å‘ä¸Šæ»šåŠ¨[m
[32m+[m[32m            {[m
[32m+[m[32m                isAutoScrollEnabled = false;[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m[32m        /// <summary>[m
[32m+[m[32m        /// æ™ºèƒ½è‡ªåŠ¨æ»šåŠ¨[m
[32m+[m[32m        /// </summary>[m
[32m+[m[32m        private void SmartAutoScroll(Control targetControl = null)[m
[32m+[m[32m        {[m
[32m+[m[32m            if (!isAutoScrollEnabled) return;[m
[32m+[m
[32m+[m[32m            // å¦‚æœç”¨æˆ·åˆšåˆšæ‰‹åŠ¨æ»šåŠ¨ï¼ˆ1ç§’å†…ï¼‰ï¼Œåˆ™ä¸è‡ªåŠ¨æ»šåŠ¨[m
[32m+[m[32m            if ((DateTime.Now - lastUserScrollTime).TotalMilliseconds < 1000)[m
[32m+[m[32m            {[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            try[m
[32m+[m[32m            {[m
[32m+[m[32m                if (targetControl != null)[m
[32m+[m[32m                {[m
[32m+[m[32m                    // æ»šåŠ¨åˆ°æŒ‡å®šæ§ä»¶[m
[32m+[m[32m                    conversationPanel.ScrollControlIntoView(targetControl);[m
[32m+[m[32m                }[m
[32m+[m[32m                else[m
[32m+[m[32m                {[m
[32m+[m[32m                    // æ»šåŠ¨åˆ°åº•éƒ¨[m
[32m+[m[32m                    if (conversationPanel.Controls.Count > 0)[m
[32m+[m[32m                    {[m
[32m+[m[32m                        var lastControl = conversationPanel.Controls[conversationPanel.Controls.Count - 1];[m
[32m+[m[32m                        conversationPanel.ScrollControlIntoView(lastControl);[m
[32m+[m[32m                    }[m
[32m+[m[32m                }[m
[32m+[m[32m            }[m
[32m+[m[32m            catch (Exception ex)[m
[32m+[m[32m            {[m
[32m+[m[32m                System.Diagnostics.Debug.WriteLine($"Auto scroll error: {ex.Message}");[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /// <summary>[m
[32m+[m[32m        /// å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ–°æ¶ˆæ¯æ—¶ä½¿ç”¨ï¼‰[m
[32m+[m[32m        /// </summary>[m
[32m+[m[32m        private void ScrollToBottom()[m
[32m+[m[32m        {[m
[32m+[m[32m            isAutoScrollEnabled = true;[m
[32m+[m[32m            SmartAutoScroll();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        #endregion[m
[32m+[m
[32m+[m[32m        #region æ¶ˆæ¯å¤„ç†[m
         public async Task<string> SendAsync(string message)[m
         {[m
             if (string.IsNullOrWhiteSpace(message)) return null;[m
[36m@@ -90,7 +205,6 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                 Action<string> updateFunc = null;[m
                 var aiContentControl = await AppendMessageAsync("AI", "", true, setter => updateFunc = setter);[m
                 fullAIResponse = await GetAIResponse(message, updateFunc);[m
[31m-                System.IO.File.AppendAllText("C:\\ai_debug_log.txt", $"[SendAsync DONE] {fullAIResponse}\n");[m
             }[m
             catch (Exception ex)[m
             {[m
[36m@@ -112,6 +226,7 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
             inputTextBox.Clear();[m
 [m
             await AppendMessageAsync("ç”¨æˆ·", userMessage);[m
[32m+[m[32m            ScrollToBottom();[m
 [m
             sendButton.Enabled = false;[m
 [m
[36m@@ -120,18 +235,20 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                 Action<string> updateFunc = null;[m
                 // ç­‰å¾… AI æ§ä»¶åˆå§‹åŒ–å¹¶è·å¾—æ›´æ–°å‡½æ•°[m
                 var aiContentControl = await AppendMessageAsync("AI", "", true, setter => updateFunc = setter);[m
[32m+[m[32m                // è®¾ç½®å½“å‰AIæ§ä»¶[m
[32m+[m[32m                currentAIControl = aiContentControl;[m
                 await GetAIResponse(userMessage, updateFunc);[m
             }[m
             finally[m
             {[m
                 sendButton.Enabled = true;[m
[32m+[m[32m                currentAIControl = null;[m
             }[m
         }[m
         // æµå¼è¾“å‡º[m
         public async Task<Control> AppendMessageAsync(string sender, string message, bool isStreaming = false, Action<Action<string>> setUpdateContent = null)[m
         {[m
             if (string.IsNullOrWhiteSpace(message) && !isStreaming) return null;[m
[31m-[m
             Control contentControl;[m
 [m
             if (sender == "AI")[m
[36m@@ -140,77 +257,351 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                 {[m
                     Width = conversationPanel.Width - 150,[m
                     Margin = new Padding(0),[m
[31m-                    Height = 1,[m
[31m-                    DefaultBackgroundColor = Color.White[m
[32m+[m[32m                    Height = 50,[m
[32m+[m[32m                    DefaultBackgroundColor = Color.White  // AIå›å¤çš„æ°”æ³¡é¢œè‰²[m
                 };[m
 [m
                 await webView.EnsureCoreWebView2Async();[m
[31m-[m
                 if (webView.CoreWebView2 != null)[m
                 {[m
[32m+[m[32m                    // æ·»åŠ èŠ‚æµå˜é‡[m
[32m+[m[32m                    DateTime lastScrollTime = DateTime.MinValue;[m
[32m+[m[32m                    int lastHeight = 0;[m
[32m+[m
                     webView.CoreWebView2.WebMessageReceived += (s, a) =>[m
                     {[m
                         if (int.TryParse(a.WebMessageAsJson, out int height))[m
                         {[m
[31m-                            Action update = () =>[m
[32m+[m[32m                            // åªæœ‰é«˜åº¦å˜åŒ–æ˜¾è‘—æ—¶æ‰æ›´æ–°[m
[32m+[m[32m                            if (Math.Abs(height - lastHeight) > 10)[m
                             {[m
[31m-                                webView.Height = Math.Max(height, 1);[m
[31m-                                // â­ å…³é”®ï¼šæ›´æ–°é«˜åº¦åå†æ»šåŠ¨[m
[31m-                                conversationPanel.ScrollControlIntoView(webView);[m
[31m-                            };[m
[31m-[m
[31m-                            if (webView.InvokeRequired)[m
[31m-                                webView.Invoke(update);[m
[31m-                            else[m
[31m-                                update();[m
[32m+[m[32m                                lastHeight = height;[m
[32m+[m[32m                                Action update = () =>[m
[32m+[m[32m                                {[m
[32m+[m[32m                                    webView.Height = Math.Max(height, 50);[m
[32m+[m
[32m+[m[32m                                    // èŠ‚æµæ»šåŠ¨ï¼šé™åˆ¶æ»šåŠ¨é¢‘ç‡[m
[32m+[m[32m                                    var now = DateTime.Now;[m
[32m+[m[32m                                    if ((now - lastScrollTime).TotalMilliseconds > 150) // 150msèŠ‚æµ[m
[32m+[m[32m                                    {[m
[32m+[m[32m                                        lastScrollTime = now;[m
[32m+[m
[32m+[m[32m                                        // å»¶è¿Ÿæ»šåŠ¨ï¼Œè®©ç•Œé¢æœ‰æ—¶é—´æ›´æ–°[m
[32m+[m[32m                                        Task.Delay(30).ContinueWith(_ =>[m
[32m+[m[32m                                        {[m
[32m+[m[32m                                            if (webView.IsHandleCreated && !webView.IsDisposed)[m
[32m+[m[32m                                            {[m
[32m+[m[32m                                                webView.Invoke(new Action(() =>[m
[32m+[m[32m                                                {[m
[32m+[m[32m                                                    // åªæœ‰å½“å‰WebViewæ˜¯æ­£åœ¨æ›´æ–°çš„AIæ§ä»¶æ—¶æ‰æ»šåŠ¨[m
[32m+[m[32m                                                    if (currentAIControl == webView)[m
[32m+[m[32m                                                    {[m
[32m+[m[32m                                                        SmartAutoScroll(webView);[m
[32m+[m[32m                                                    }[m
[32m+[m[32m                                                }));[m
[32m+[m[32m                                            }[m
[32m+[m[32m                                        });[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                };[m
[32m+[m
[32m+[m[32m                                if (webView.InvokeRequired)[m
[32m+[m[32m                                    webView.Invoke(update);[m
[32m+[m[32m                                else[m
[32m+[m[32m                                    update();[m
[32m+[m[32m                            }[m
                         }[m
                     };[m
 [m
[31m-                    string html = Markdig.Markdown.ToHtml(message ?? "");[m
[31m-                    string doc = $"<html><head><script>window.MathJax={{tex:{{inlineMath:[['$','$'],['\\\\(','\\\\)']],displayMath:[['$$','$$'],['\\\\[','\\\\]']]}},svg:{{fontCache:'global'}}}};</script><script src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script></head><body id='body' style='font-family:å¾®è½¯é›…é»‘;font-size:10pt;background-color:#FFFFFF;margin:0;padding:0;'>{html}<script>function setContent(html){{const body=document.getElementById('body');body.innerHTML=html;if(window.MathJax){{MathJax.typesetPromise([body]).then(()=>{{setTimeout(()=>{{const height=Math.max(body.scrollHeight,document.documentElement.scrollHeight);window.chrome.webview.postMessage(height);}},100);}});}}else{{setTimeout(()=>{{const height=Math.max(body.scrollHeight,document.documentElement.scrollHeight);window.chrome.webview.postMessage(height);}},100);}}const resizeObserver=new ResizeObserver(()=>{{const newHeight=Math.max(body.scrollHeight,document.documentElement.scrollHeight);window.chrome.webview.postMessage(newHeight);}});resizeObserver.observe(body);}}if(window.MathJax)MathJax.typesetPromise();const initialHeight=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight);window.chrome.webview.postMessage(initialHeight);</script></body></html>";[m
[32m+[m[32m                    // ä¼˜åŒ–HTMLç»“æ„ï¼Œå‡å°‘é‡æ’[m
[32m+[m[32m                    var pipeline = new MarkdownPipelineBuilder()[m
[32m+[m[32m                                        .UseAdvancedExtensions()  // âœ… å¯ç”¨ GFM è¡¨æ ¼ç­‰æ”¯æŒ[m
[32m+[m[32m                                        .Build();[m
[32m+[m
[32m+[m[32m                    string html = Markdown.ToHtml(message ?? "", pipeline);[m
[32m+[m[32m                    string doc = $@"[m
[32m+[m[32m<html>[m
[32m+[m[32m<head>[m
[32m+[m[32m    <script>[m
[32m+[m[32m        window.MathJax = {{[m
[32m+[m[32m            tex: {{[m
[32m+[m[32m                inlineMath: [['$','$'], ['\\(','\\)']],[m
[32m+[m[32m                displayMath: [['$$','$$'], ['\\[','\\]']][m
[32m+[m[32m            }},[m
[32m+[m[32m            svg: {{[m
[32m+[m[32m                fontCache: 'global'[m
[32m+[m[32m            }}[m
[32m+[m[32m        }};[m
[32m+[m[32m    </script>[m
[32m+[m[32m    <script src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>[m
[32m+[m[32m    <style>[m
[32m+[m[32m        html, body {{[m
[32m+[m[32m            margin: 0;[m
[32m+[m[32m            padding: 0;[m
[32m+[m[32m            font-family: å¾®è½¯é›…é»‘;[m
[32m+[m[32m            font-size: 14px;[m
[32m+[m[32m            background-color: #FFFFFF;[m
[32m+[m[32m            line-height: 1.6;[m
[32m+[m[32m            word-wrap: break-word;[m
[32m+[m[32m            /* âœ… å…³é”®ï¼šç¦ç”¨æ»šåŠ¨æ¡ */[m
[32m+[m[32m            overflow: hidden !important;[m
[32m+[m[32m            overflow-x: hidden !important;[m
[32m+[m[32m            overflow-y: hidden !important;[m
[32m+[m[32m        }}[m
[32m+[m[32m        .content {{[m
[32m+[m[32m            padding: 8px;[m
[32m+[m[32m            min-height: 40px; /* âœ… è®¾ç½®æœ€å°é«˜åº¦ */[m
[32m+[m[32m            /* âœ… ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡º */[m
[32m+[m[32m            overflow: hidden;[m
[32m+[m[32m            word-break: break-word;[m
[32m+[m[32m        }}[m
[32m+[m[32m        /* âœ… æ–°å¢ï¼šè¡¨æ ¼æ ·å¼ - å…³é”®ä¿®å¤ */[m
[32m+[m[32m        table {{[m
[32m+[m[32m            border-collapse: collapse;[m
[32m+[m[32m            width: 100%;[m
[32m+[m[32m            max-width: 100%;[m
[32m+[m[32m            margin: 10px 0;[m
[32m+[m[32m            background-color: #fff;[m
[32m+[m[32m            /* âœ… é˜²æ­¢è¡¨æ ¼æº¢å‡º */[m
[32m+[m[32m            table-layout: fixed;[m
[32m+[m[32m            word-wrap: break-word;[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        th, td {{[m
[32m+[m[32m            border: 1px solid #ddd;[m
[32m+[m[32m            padding: 8px 12px;[m
[32m+[m[32m            text-align: left;[m
[32m+[m[32m            vertical-align: top;[m
[32m+[m[32m            /* âœ… ç¡®ä¿å•å…ƒæ ¼å†…å®¹ä¸æº¢å‡º */[m
[32m+[m[32m            overflow: hidden;[m
[32m+[m[32m            word-break: break-word;[m
[32m+[m[32m            hyphens: auto;[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        th {{[m
[32m+[m[32m            background-color: #f2f2f2;[m
[32m+[m[32m            font-weight: bold;[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        /* âœ… å“åº”å¼è¡¨æ ¼ */[m
[32m+[m[32m        @media screen and (max-width: 600px) {{[m
[32m+[m[32m            table {{[m
[32m+[m[32m                font-size: 12px;[m
[32m+[m[32m            }}[m
[32m+[m[32m            th, td {{[m
[32m+[m[32m                padding: 6px 8px;[m
[32m+[m[32m            }}[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        /* âœ… å¤„ç†é•¿å†…å®¹ */[m
[32m+[m[32m        .content table {{[m
[32m+[m[32m            overflow-wrap: break-word;[m
[32m+[m[32m            word-wrap: break-word;[m
[32m+[m[32m        }}[m
[32m+[m[32m        /* âœ… éšè—æ‰€æœ‰å¯èƒ½çš„æ»šåŠ¨æ¡ */[m
[32m+[m[32m        ::-webkit-scrollbar {{[m
[32m+[m[32m            display: none !important;[m
[32m+[m[32m            width: 0 !important;[m
[32m+[m[32m            height: 0 !important;[m
[32m+[m[32m        }}[m
[32m+[m[32m        * {{[m
[32m+[m[32m            scrollbar-width: none !important;[m
[32m+[m[32m            -ms-overflow-style: none !important;[m
[32m+[m[32m        }}[m
[32m+[m[32m    </style>[m
[32m+[m[32m</head>[m
[32m+[m[32m<body>[m
[32m+[m[32m    <div id='content' class='content'>{html}</div>[m
[32m+[m[32m    <script>[m
[32m+[m[32m        let updateTimer = null;[m
[32m+[m[32m        let isUpdating = false;[m
[32m+[m[32m        let lastReportedHeight = 0;[m
[32m+[m[41m        [m
[32m+[m[32m        function debounceHeightUpdate() {{[m
[32m+[m[32m            if (updateTimer) {{[m
[32m+[m[32m                clearTimeout(updateTimer);[m
[32m+[m[32m            }}[m
[32m+[m[32m            updateTimer = setTimeout(() => {{[m
[32m+[m[32m                const content = document.getElementById('content');[m
[32m+[m[41m                [m
[32m+[m[32m                // âœ… æ›´å‡†ç¡®çš„é«˜åº¦è®¡ç®—[m
[32m+[m[32m                const height = Math.max([m
[32m+[m[32m                    content.scrollHeight + 16, // padding[m
[32m+[m[32m                    content.offsetHeight + 16,[m
[32m+[m[32m                    document.documentElement.scrollHeight,[m
[32m+[m[32m                    document.body.scrollHeight,[m
[32m+[m[32m                    50 // æœ€å°é«˜åº¦[m
[32m+[m[32m                );[m
[32m+[m[41m                [m
[32m+[m[32m                // âœ… é¿å…é¢‘ç¹å‘é€ç›¸åŒé«˜åº¦[m
[32m+[m[32m                if (Math.abs(height - lastReportedHeight) > 3) {{[m
[32m+[m[32m                    lastReportedHeight = height;[m
[32m+[m[32m                    window.chrome.webview.postMessage(height);[m
[32m+[m[32m                }}[m
[32m+[m[32m            }}, 30); // å‡å°‘é˜²æŠ–æ—¶é—´ï¼Œæ›´å¿«å“åº”[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        function setContent(html) {{[m
[32m+[m[32m            if (isUpdating) return;[m
[32m+[m[32m            isUpdating = true;[m
[32m+[m[41m            [m
[32m+[m[32m            const content = document.getElementById('content');[m
[32m+[m[41m            [m
[32m+[m[32m            // âœ… ä½¿ç”¨æ›´é«˜æ•ˆçš„DOMæ›´æ–°æ–¹å¼[m
[32m+[m[32m            requestAnimationFrame(() => {{[m
[32m+[m[32m                try {{[m
[32m+[m[32m                    content.innerHTML = html;[m
[32m+[m[41m                    [m
[32m+[m[32m                    // âœ… ç«‹å³è®¡ç®—å¹¶æŠ¥å‘Šé«˜åº¦ï¼Œé¿å…æ»šåŠ¨æ¡é—ªç°[m
[32m+[m[32m                    const immediateHeight = Math.max([m
[32m+[m[32m                        content.scrollHeight + 16,[m
[32m+[m[32m                        content.offsetHeight + 16,[m
[32m+[m[32m                        50[m
[32m+[m[32m                    );[m
[32m+[m[41m                    [m
[32m+[m[32m                    if (Math.abs(immediateHeight - lastReportedHeight) > 3) {{[m
[32m+[m[32m                        lastReportedHeight = immediateHeight;[m
[32m+[m[32m                        window.chrome.webview.postMessage(immediateHeight);[m
[32m+[m[32m                    }}[m
[32m+[m[41m                    [m
[32m+[m[32m                    if (window.MathJax) {{[m
[32m+[m[32m                        MathJax.typesetPromise([content]).then(() => {{[m
[32m+[m[32m                            debounceHeightUpdate();[m
[32m+[m[32m                            isUpdating = false;[m
[32m+[m[32m                        }}).catch(() => {{[m
[32m+[m[32m                            debounceHeightUpdate();[m
[32m+[m[32m                            isUpdating = false;[m
[32m+[m[32m                        }});[m
[32m+[m[32m                    }} else {{[m
[32m+[m[32m                        debounceHeightUpdate();[m
[32m+[m[32m                        isUpdating = false;[m
[32m+[m[32m                    }}[m
[32m+[m[32m                }} catch (e) {{[m
[32m+[m[32m                    console.error('Content update error:', e);[m
[32m+[m[32m                    isUpdating = false;[m
[32m+[m[32m                }}[m
[32m+[m[32m            }});[m
[32m+[m[32m        }}[m
[32m+[m[41m        [m
[32m+[m[32m        // åˆå§‹åŒ–[m
[32m+[m[32m        document.addEventListener('DOMContentLoaded', function() {{[m
[32m+[m[32m            if (window.MathJax) {{[m
[32m+[m[32m                MathJax.typesetPromise().then(() => {{[m
[32m+[m[32m                    debounceHeightUpdate();[m
[32m+[m[32m                }});[m
[32m+[m[32m            }} else {{[m
[32m+[m[32m                debounceHeightUpdate();[m
[32m+[m[32m            }}[m
[32m+[m[32m        }});[m
[32m+[m[41m        [m
[32m+[m[32m        // âœ… ä¼˜åŒ–çš„è§‚å¯Ÿå™¨ï¼Œå‡å°‘è§¦å‘é¢‘ç‡[m
[32m+[m[32m        const observer = new MutationObserver((mutations) => {{[m
[32m+[m[32m            let shouldUpdate = false;[m
[32m+[m[32m            mutations.forEach(mutation => {{[m
[32m+[m[32m                if (mutation.type === 'childList' ||[m[41m [m
[32m+[m[32m                    (mutation.type === 'characterData' && mutation.target.textContent.length > 0)) {{[m
[32m+[m[32m                    shouldUpdate = true;[m
[32m+[m[32m                }}[m
[32m+[m[32m            }});[m
[32m+[m[41m            [m
[32m+[m[32m            if (shouldUpdate) {{[m
[32m+[m[32m                debounceHeightUpdate();[m
[32m+[m[32m            }}[m
[32m+[m[32m        }});[m
[32m+[m[41m        [m
[32m+[m[32m        observer.observe(document.getElementById('content'), {{[m
[32m+[m[32m            childList: true,[m
[32m+[m[32m            subtree: true,[m
[32m+[m[32m            characterData: true[m
[32m+[m[32m        }});[m
[32m+[m[41m        [m
[32m+[m[32m        // âœ… é¡µé¢åŠ è½½å®Œæˆåç«‹å³æŠ¥å‘Šé«˜åº¦[m
[32m+[m[32m        window.addEventListener('load', function() {{[m
[32m+[m[32m            debounceHeightUpdate();[m
[32m+[m[32m        }});[m
[32m+[m[32m    </script>[m
[32m+[m[32m</body>[m
[32m+[m[32m</html>";[m
[32m+[m
                     webView.CoreWebView2.NavigateToString(doc);[m
 [m
                     if (setUpdateContent != null)[m
                     {[m
[32m+[m[32m                        // æ·»åŠ æ›´æ–°èŠ‚æµ[m
[32m+[m[32m                        DateTime lastUpdateTime = DateTime.MinValue;[m
[32m+[m[32m                        string lastContent = "";[m
[32m+[m
                         Action<string> updateContent = (newContent) =>[m
                         {[m
[31m-                            string htmlUpdate = Markdig.Markdown.ToHtml(newContent).Replace("`", "\\`");[m
[32m+[m[32m                            // å†…å®¹å»é‡[m
[32m+[m[32m                            if (newContent == lastContent) return;[m
[32m+[m[32m                            lastContent = newContent;[m
 [m
[31m-                            if (webView.InvokeRequired)[m
[32m+[m[32m                            // æ›´æ–°é¢‘ç‡æ§åˆ¶[m
[32m+[m[32m                            var now = DateTime.Now;[m
[32m+[m[32m                            if ((now - lastUpdateTime).TotalMilliseconds < 100) // 100mså†…ä¸é‡å¤æ›´æ–°[m
                             {[m
[31m-                                webView.Invoke(new Action(() =>[m
[32m+[m[32m                                return;[m
[32m+[m[32m                            }[m
[32m+[m[32m                            lastUpdateTime = now;[m
[32m+[m
[32m+[m[32m                            try[m
[32m+[m[32m                            {[m
[32m+[m[32m                                string htmlUpdate = Markdig.Markdown.ToHtml(newContent)[m
[32m+[m[32m                                    .Replace("`", "\\`")[m
[32m+[m[32m                                    .Replace("\\", "\\\\")[m
[32m+[m[32m                                    .Replace("'", "\\'")[m
[32m+[m[32m                                    .Replace("\r\n", "\\n")[m
[32m+[m[32m                                    .Replace("\n", "\\n");[m
[32m+[m
[32m+[m[32m                                if (webView.IsHandleCreated && !webView.IsDisposed)[m
                                 {[m
[31m-                                    webView.CoreWebView2.ExecuteScriptAsync($"setContent(`{htmlUpdate}`);");[m
[31m-                                    conversationPanel.ScrollControlIntoView(webView);[m
[31m-                                    // âŒ ä¸åœ¨è¿™é‡Œæ»šåŠ¨[m
[31m-                                }));[m
[32m+[m[32m                                    if (webView.InvokeRequired)[m
[32m+[m[32m                                    {[m
[32m+[m[32m                                        webView.Invoke(new Action(() =>[m
[32m+[m[32m                                        {[m
[32m+[m[32m                                            webView.CoreWebView2?.ExecuteScriptAsync($"setContent(`{htmlUpdate}`);");[m
[32m+[m[32m                                        }));[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                    else[m
[32m+[m[32m                                    {[m
[32m+[m[32m                                        webView.CoreWebView2?.ExecuteScriptAsync($"setContent(`{htmlUpdate}`);");[m
[32m+[m[32m                                    }[m
[32m+[m[32m                                }[m
                             }[m
[31m-                            else[m
[32m+[m[32m                            catch (Exception ex)[m
                             {[m
[31m-                                webView.CoreWebView2.ExecuteScriptAsync($"setContent(`{htmlUpdate}`);");[m
[31m-                                conversationPanel.ScrollControlIntoView(webView);[m
[31m-                                // âŒ ä¸åœ¨è¿™é‡Œæ»šåŠ¨[m
[32m+[m[32m                                // è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­æµç¨‹[m
[32m+[m[32m                                System.Diagnostics.Debug.WriteLine($"WebView update error: {ex.Message}");[m
                             }[m
                         };[m
 [m
                         setUpdateContent(updateContent);[m
                     }[m
                 }[m
[31m-[m
[32m+[m[32m                conversationPanel.Controls.Add(webView);[m
                 contentControl = webView;[m
             }[m
             else[m
             {[m
[31m-                contentControl = new Label[m
[32m+[m[32m                contentControl = new TextBox[m
                 {[m
                     Text = message,[m
[31m-                    AutoSize = true,[m
[31m-                    Font = new System.Drawing.Font("å¾®è½¯é›…é»‘", 10),[m
[32m+[m[32m                    Font = new System.Drawing.Font("å¾®è½¯é›…é»‘", fontsize),[m
                     MaximumSize = new Size(conversationPanel.Width - 150, 0),[m
                     Padding = new Padding(10),[m
                     BackColor = Color.LightBlue,[m
[31m-                    Margin = new Padding(5)[m
[32m+[m[32m                    Margin = new Padding(5),[m
[32m+[m[32m                    BorderStyle = BorderStyle.None, // çœ‹èµ·æ¥åƒLabel[m
[32m+[m[32m                    ReadOnly = true,                // åªè¯»[m
[32m+[m[32m                    Multiline = true,              // æ”¯æŒå¤šè¡Œ[m
[32m+[m[32m                    ScrollBars = ScrollBars.None,  // ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡[m
[32m+[m[32m                    TabStop = false,               // ä¸å‚ä¸Tabå¯¼èˆª[m
[32m+[m[32m                    Cursor = Cursors.IBeam         // æ–‡æœ¬å…‰æ ‡[m
                 };[m
[32m+[m[32m                Size textSize = TextRenderer.MeasureText(message, contentControl.Font, contentControl.MaximumSize, TextFormatFlags.WordBreak);[m
[32m+[m[32m                contentControl.Height = textSize.Height + 10; // +10 æ˜¯é¢å¤–å¡«å……é˜²æ­¢è¢«è£åˆ‡[m
[32m+[m[32m                contentControl.Width = Math.Min(textSize.Width + contentControl.Padding.Horizontal, conversationPanel.Width - 150);[m
[32m+[m[32m                contentControl.Height = textSize.Height + contentControl.Padding.Vertical;[m
             }[m
 [m
             // å¤´åƒ[m
[36m@@ -266,6 +657,17 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
 [m
             return contentControl;[m
         }[m
[32m+[m[32m        private void ConversationPanel_Resize(object sender, EventArgs e)[m
[32m+[m[32m        {[m
[32m+[m[32m            // é¢æ¿å¤§å°æ”¹å˜æ—¶ï¼Œå¦‚æœåœ¨åº•éƒ¨åˆ™ä¿æŒåœ¨åº•éƒ¨[m
[32m+[m[32m            if (isAutoScrollEnabled && IsNearBottom())[m
[32m+[m[32m            {[m
[32m+[m[32m                Task.Delay(100).ContinueWith(_ =>[m
[32m+[m[32m                {[m
[32m+[m[32m                    this.Invoke(new Action(() => SmartAutoScroll()));[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
         // éæµå¼è¾“å‡º[m
         public Task<Control> AppendMessageSync(string sender, string message)[m
         {[m
[36m@@ -291,7 +693,7 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
 <html><head>[m
 <script src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>[m
 </head>[m
[31m-<body style='font-family:å¾®è½¯é›…é»‘;font-size:10pt;background-color:#FFFFFF;margin:0;padding:0;'>[m
[32m+[m[32m<body style='font-family:å¾®è½¯é›…é»‘;font-size:{htmlsize};background-color:#FFFFFF;margin:0;padding:0;'>[m
 {html}[m
 </body></html>";[m
 [m
[36m@@ -304,7 +706,7 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
                 {[m
                     Text = message,[m
                     AutoSize = true,[m
[31m-                    Font = new System.Drawing.Font("å¾®è½¯é›…é»‘", 10),[m
[32m+[m[32m                    Font = new System.Drawing.Font("å¾®è½¯é›…é»‘", fontsize),[m
                     MaximumSize = new Size(conversationPanel.Width - 150, 0),[m
                     Padding = new Padding(10),[m
                     BackColor = Color.LightBlue,[m
[36m@@ -370,6 +772,7 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
 [m
             return Task.FromResult<Control>(contentControl);[m
         }[m
[32m+[m[32m        #endregion[m
 [m
         // æµå¼è°ƒç”¨[m
         public async Task<string> GetAIResponse(string userMessage, Action<string> updateContent)[m
[36m@@ -387,7 +790,7 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
             new ChatRequest.MessagesType[m
             {[m
                 Role = ChatRequest.RoleEnum.System,[m
[31m-                Content = "ä½ çš„åå­—æ˜¯\"ç”µæ°”è®¾è®¡åŠ©æ‰‹\"ï¼Œæ˜¯ä¸€ä¸ªç”µæ°”è®¾è®¡é¢†åŸŸçš„AutoCADåŠ©æ‰‹ï¼Œè¯·å›ç­”æœ‰å…³ç”µæ°”è®¾è®¡é¢†åŸŸçš„CADæ“ä½œçš„é—®é¢˜æˆ–è€…ç›¸å…³çš„ç”µæ°”çŸ¥è¯†"[m
[32m+[m[32m                Content = "ä½ çš„åå­—æ˜¯\"ç”µæ°”è®¾è®¡åŠ©æ‰‹\"ï¼Œæ˜¯ä¸€ä¸ªç”µæ°”è®¾è®¡é¢†åŸŸçš„AutoCADåŠ©æ‰‹ï¼Œè¯·å›ç­”æœ‰å…³ç”µæ°”è®¾è®¡é¢†åŸŸçš„é—®é¢˜å¹¶è¿”å›åŸå§‹çš„Markdownæ ¼å¼"[m
             },[m
             new ChatRequest.MessagesType[m
             {[m
[36m@@ -470,23 +873,6 @@[m [mnamespace CoDesignStudy.Cad.PlugIn[m
         {[m
             conversationPanel.Controls.Clear();[m